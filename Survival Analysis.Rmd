---
title: "Survival analysis"
author: "Sasha Ajay Malkani"
date: "2023-10-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Read CSV file}

# Read CSV file

addicts <- read.csv("addicts.csv")
addicts[1:5,]
addicts[1:5,1:6]
```


```{r 1 - Creating a survival object}

library(survival)
Surv(addicts$survt,addicts$status==1)
```

```{r 2 - Estimating survival functions (unadjusted) and comparing them across strata}

summary(survfit(Surv(addicts$survt,addicts$status==1)~1))
Y=Surv(addicts$survt,addicts$status==1)
Y~1
Y~addicts$clinic
kmfit1=survfit(Y~1)
kmfit1
summary(kmfit1)
summary(kmfit1,times=365)
kmfit2=survfit(Y~addicts$clinic)
summary(kmfit2,times=c(0,100,200,300,400,500,600,700,800,900,1000))
summary(kmfit2,times=100*(0:10))
plot(kmfit2)
plot(kmfit2, lty=c("solid", "dashed"), col=c("black","grey"),
     xlab="survival time in days", ylab="survival probabilities")
plot(kmfit2, lty = c("solid", "dashed"), col=c("red","green"),
     xlab="survival time in days", ylab="survival probabilities")

survdiff(Surv(survt,status)~clinic, data=addicts)

attach(addicts)
survdiff(Surv(survt,status)~clinic)

detach(addicts)

survdiff(Surv(survt,status)~clinic,data=addicts,rho = 1)

survdiff(Surv(survt,status)~clinic + strata(prison),data=addicts)

```




```{r 3 - Assessing the PH assumption using graphical approaches}
plot(kmfit2,fun="cloglog",xlab = "time in days using logarithmic scale",
     ylab = "log-logsurvival",main="log-log curves by clinic")

kmfit3=summary(kmfit2)
names(kmfit3)
kmfit4=data.frame(kmfit3$strata,kmfit3$time,kmfit3$surv)
names(kmfit4)=c("clinic","time","survival")

kmfit4[1:5,]

clinic1=kmfit4[kmfit4$clinic=="addicts$clinic=1",]
clinic2=kmfit4[kmfit4$clinic=="addicts$clinic=2",]

clinic1[1:5,]
clinic2[1:5,]

plot(clinic1$time,log(-log(clinic1$survival)),
     xlab = "survival time in days",ylab = "log-log survival",
     xlim=c(0,800),col="black",type='l',lty="solid",main="log-log curves by clinic")

par(new=T)
plot(clinic2$time,log(-log(clinic2$survival)),axes=F,xlab = "survival time in days",
     ylab="log-log survival",col="grey50",type='l',lty="dashed")

legend("bottomright",c("Clinic 1","Clinic 2"),
       lty = c("solid","dashed"),col = c("black","grey50"))


```


```{r 4 - Running a COX PH model}

Y=Surv(addicts$survt,addicts$status==1)

coxph(Y~prison + dose + clinic,data=addicts)

```

```{r Detailed COX PH model}

summary(coxph(Y~prison+dose+clinic,data=addicts))

```

```{r Handling ties (i.e. more than one event in a defined time interval) - several methods}

coxph(Y~prison + dose + clinic,data=addicts, method="efron")
coxph(Y~prison + dose + clinic,data=addicts, method="breslow")
coxph(Y~prison + dose + clinic,data=addicts, method="exact")


```

```{r Significance of interactions: mod 1 - the reduced model, mod 2 - the full model}

mod1=coxph(Y~prison + dose + clinic,data=addicts)
mod2=coxph(Y~prison + dose + clinic + clinic*prison + clinic*dose, data=addicts)

mod1

mod2

```

```{r Utilising information from mod 1 and mod 2}

names(mod2)

```

```{r Call up the log-likelihood function - first term - model with no predictors, second term - model with predictors}

mod2$loglik

```

```{r or}

mod2[[3]]

```

```{r calculate the difference in -2 Log-likelihood (deviance) of the two models}

(-2)*(mod1$loglik[2]-mod2$loglik[2])

```

```{r Determine the significance between the models using Chi-square statistic}

LRT=(-2)*(mod1$loglik[2]-mod2$loglik[2])
Pvalue = 1 - pchisq(LRT,2)
Pvalue

```

```{r Determine the significance between models using a self-defined function.}

lrt.surv=function(mod.full,mod.reduced,df){
  lrts=(-2)*(mod.full$loglik[2]-mod.reduced$loglik[2])
  pvalue=1-pchisq(lrts,df)
  return(pvalue)
}

lrt.surv(mod1,mod2, 2)

```

```{r 5 - Running a stratified Cox model}

Y=Surv(addicts$survt,addicts$status==1)
coxph(Y~ prison + dose + strata(clinic),data = addicts)

```

```{r Including interaction term in a stratified Cox model}

coxph(Y~prison + dose + clinic:prison + clinic:dose + strata(clinic),data=addicts)

```

```{r Estimating hazard ratio }

# for PRISON=1 vs PRISON=0 for CLINIC=2

addicts$clinic2=addicts$clinic-2
summary(coxph(Y~prison + dose + clinic2:prison +
                clinic2:dose+strata(clinic2),data=addicts))

```

```{r 6 - Assessing the PH assumption with a statistical test}

Y=Surv(addicts$survt,addicts$status==1)
mod1=coxph(Y~prison + dose + clinic,data=addicts)

cox.zph(mod1,transform=rank)

```

```{r plot of schoenfeld residuals against each individuals failure time.}

plot(cox.zph(mod1,transform=rank),se=F,var='clinic')

```

```{r 7 - Obtaining Cox-adjusted survival curves}

# Run Cox unadjusted model

Y=Surv(addicts$survt,addicts$status==1)
mod1=coxph(Y~prison + dose + clinic, data=addicts)

# Adjusted Cox model with the adjustments as follows
 # PRISON = 0, DOSE=70 AND CLINIC=2
 # CREATE DATA FRAME FIRST

pattern1=data.frame(prison=0,dose=70,clinic=2)

pattern1

 # use summary function to get the Cox adjusted survival estimates

summary(survfit(mod1,newdata=pattern1))

 # plot of the adjusted survival curve

plot(survfit(mod1, newdata=pattern1),
     conf.int=F,main="Adjusted survival for prison=0, dose=70, clinic=2")


```

```{r stratified Cox adjusted survival curves}

# stratified cox model

mod3=coxph(Y~prison + dose + strata(clinic),data=addicts)

 # stratified cox model controlling for PRISON and DOSE
 # Creation of one observation data frame, with the mean for prison and dose.

pattern2=data.frame(prison=0.46,dose=60.40)

 #Plotting adjusted survival curve with clinic as the strata

plot(survfit(mod3,newdata=pattern2), conf.int=F, lty=c("solid","dashed"), 
     col=c("red","green"), main="Survival curves for clinic, adjusted for prison and dose")
legend("topright",c("Clinic 1","Clinic 2"),lty=c("solid","dashed"), col=c("red","green"))

 # Plotting adjusted log-log survival curves for clinic

plot(survfit(mod3,newdata = pattern2),fun="cloglog",
     main="Log-Log curves for clinic, adjusted for prison and dose")

 # Plotting adjusted log-log survival curves for clinic with the time scale not logged

sum.mod3=summary(survfit(mod3,newdata=pattern2))

 # similar code to section 3

sum.mod4=data.frame(sum.mod3$strata,sum.mod3$time,sum.mod3$surv)
colnames(sum.mod4)=c("clinic","time","survival")
clinic1=sum.mod4[sum.mod4$clinic=="clinic=1",]
clinic2=sum.mod4[sum.mod4$clinic=="clinic=2",]

 # plot

plot(clinic1$time,log(-log(clinic1$survival)),xlab="survival time in days",ylab="log-log survival",xlim=c(0,800),col=
       "red",type='l',lty="solid", main="log-log curves stratified by 
     clinic, adjusted for prison, dose")

par(new=T)

plot(clinic2$time,log(-log(clinic2$survival)),axes=F,xlab=
       "survival time in days",ylab="log-log survival",col="green",
     type='l',lty="dashed")

legend("bottomright",c("Clinic 1","Clinic 2"), lty=c("solid","dashed"),col=c("red","green"))

par(new=F)

```

```{r 8 - RUNNING AN EXTENDED COX MODEL}

# Transforming the dataset into counting process (start, stop) format
 # to run an extended Cox model

addicts.cp=survSplit(addicts,cut=addicts$survt[addicts$status==1], 
                     end="survt", event="status",start="start")

nrow(addicts.cp)

 # Creation of a new variable based on multiplying the variable dose with the log of the survival
 # time. This variable is created because we suspect that the variable dose has failed the proportional
 # hazards assumption.

addicts.cp$logtdose=addicts.cp$dose*log(addicts.cp$survt)

 # For the new variable DOSE=ln(DOSE)*T, which varies over time we print observation 106 
 # who had an event at time = 35 days for a selected group of variables

addicts.cp[addicts.cp$id==106,c('id','start','survt','status','dose','logtdose')]

 # Run the extended Cox model with the inclusion of predictors;
 # PRISON, DOSE, and CLINIC, and  time dependent variable LOGTDOSE

coxph(Surv(addicts.cp$start,addicts.cp$survt,addicts.cp$status) ~
        prison + dose + clinic + logtdose + cluster(id),data=addicts.cp)

 # Running the extended Cox model with a time cutpoint of 365 days
 # Essentially splitting the time of the study into observations 
 # below 365 days and observations above 365 days

addicts.cp365=survSplit(addicts,cut=365,end="survt", event="status",start="start")

 # Defining the timepoint 365 days and the two time intervals (heaviside functions) above and below 365 days

addicts.cp365$hv1=addicts.cp365$clinic*(addicts.cp365$start<365)
addicts.cp365$hv2=addicts.cp365$clinic*(addicts.cp365$start>=365)

 # Sort the dataset by variables ID and START

addicts.cp365=addicts.cp365[order(addicts.cp365$id,addicts.cp365$start),]

 # Printout of the first 10 observations for selected variables

addicts.cp365[1:10,c('id','start', 'survt','status','clinic','hv1','hv2')]

 # Running an extended Cox model with heaviside functions (time intervals)

 # Define the object for the response variable

Y365=Surv(addicts.cp365$start,addicts.cp365$survt,addicts.cp365$status)

 # Run the Cox extended model with the two heaviside functions

coxph(Y365 ~ prison + dose + hv1 + hv2 + cluster(id), data=addicts.cp365)

 # Handling ties in the two different time intervals (heaviside functions)

coxph(Y365 ~ prison + dose +hv1 + hv2,data=addicts.cp365,method="breslow")

 # Run Cox extended model with one heaviside function and the variable CLINIC

coxph(Y365 ~ prison + dose + clinic + hv2 + cluster(id),data=addicts.cp365)


```

```{r 9 RUNNING PARAMETRIC MODELS}

 # log-log survival vs time in days using log-time plot

plot(survfit(Y~addicts$clinic),fun="cloglog",xlab="time in days using log-
     arithmic scale",ylab="log-log survival", main="log-log curves by clinic")

 # Exponential AFT model

modpar1=survreg(Surv(addicts$survt,addicts$status) ~ prison + dose +
                  clinic,data=addicts,dist="exponential")

summary(modpar1)

 # Weibull AFT model

modpar2=survreg(Surv(addicts$survt,addicts$status)
                ~ prison + dose + clinic,data=addicts,dist="weibull")

summary(modpar2)

 # Use of predict function to estimate then median or any other quantile time to event
 # for any pattern of co-variates
 # Co-variate pattern; PRISON=1, DOSE=50 AND CLINIC=1

pattern1=data.frame(prison=1,dose=50,clinic=1)
pct=c(0.25,0.50,0.75)
days=predict(modpar2,newdata=pattern1,type="quantile",p=pct)
cbind(pct,days) # adds vectors pct and days to create a matrix containing both vectors

 # Creating a plot for individual with covariate pattern;  PRISON=1, DOSE=50 AND CLINIC=1

pct2=0:100/100
days2=predict(modpar2,newdata=pattern1,type="quantile",p=pct2)
survival=1-pct2

plot(days2,survival,xlab="survival time in days",ylab="survival 
     probabilities",main="Weibull survival estimates for prison=0, 
     dose=50, clinic=1",xlim=c(0,800))

 # log-logistic AFT model

modpar3=survreg(Surv(addicts$survt,addicts$status)~
                  prison + dose + clinic,data=addicts,dist="loglogistic")

summary(modpar3)

 # Kaplan Meier (KM) estimates object

kmfit2=survfit(Surv(addicts$survt,addicts$status)~addicts$clinic)

plot(log(kmfit2$time),log(kmfit2$surv/(1-kmfit2$surv)))

```

```{r 10 - RUNNING FRAILTY MODELS}


 # Re-run the stratified Cox model without the Frailty (random) component.

Y=Surv(addicts$survt,addicts$status==1)
coxph(Y~ prison + dose + strata(clinic),data=addicts)

 # Run the stratified Cox model with Frailty (random) component.

coxph(Y~ prison + dose + strata(clinic) + frailty(clinic,distribution="gamma"),data=addicts)

 # Run the Cox model without the CLINIC variable and without FRAILTY.

coxph(Y~ prison + dose,data=addicts)

 # Run the Cox model without the CLINIC variable and with FRAILTY

coxph(Y~ prison + dose + frailty(clinic,distribution="gamma"),data=addicts)

 # Detailed output for the Cox model without CLINIC variable and with FRAILTY

summary(coxph(Y~ prison + dose + frailty(clinic,distribution="gamma"), data=addicts))



```

